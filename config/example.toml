# Zwei 后端配置文件
# 复制此文件为 config.toml 并填入实际值

[app]
name = "Zwei API"
version = "1.0.0"
debug = true

[log]
level = "debug"  # debug, info, warn, error
format = "console"  # console, json

[server]
host = "0.0.0.0"
port = 18000

# 数据库配置
# 支持配置多个数据源，如果未指定则使用 database.* 的默认值
[database]
host = "localhost"      # MySQL 主机地址（默认值）
port = 3306             # MySQL 端口（默认值）
user = "zwei"           # MySQL 用户名（默认值）
password = ""           # MySQL 密码（默认值）
name = "zwei"           # 数据库名称（默认值，仅用于 CIAM）

# Zwei 数据源（业务数据：用户、菜谱、收藏等）
[database.zwei]
host = "localhost"      # 如果未指定，使用 database.host
port = 3306             # 如果未指定，使用 database.port
user = "zwei"           # 如果未指定，使用 database.user
password = ""           # 如果未指定，使用 database.password
name = "zwei"           # 数据库名称

# Auth 数据源（认证数据：客户端、用户、令牌等）
[database.auth]
host = "localhost"      # 如果未指定，使用 database.host
port = 3306             # 如果未指定，使用 database.port
user = "zwei"           # 如果未指定，使用 database.user
password = ""           # 如果未指定，使用 database.password
name = "auth"           # 数据库名称

# Redis 配置（用于存储 session、authorization_code、refresh_token）
[redis]
host = "127.0.0.1"
port = 6379
password = "helios"
db = 0
# 前缀配置（可选）
# session-prefix = "auth:session:"
# code-prefix = "auth:code:"
# refresh-token-prefix = "auth:rt:"
# user-token-prefix = "auth:user:rt:"

[cors]
origins = ["*"]
allow_credentials = true
allow_methods = ["*"]
allow_headers = ["*"]

# 阿里通义千问 API 配置 (https://dashscope.console.aliyun.com/)
[dashscope]
api-key = ""

# OpenRouter API 配置 (https://openrouter.ai/keys)
[openrouter]
api-key = ""  # OpenRouter API Key，可使用免费模型
model = "xiaomi/mimo-v2-flash:free"  # MiMo-V2-Flash 免费模型，支持工具调用，推荐用于 agent 场景

# 高德地图 API 配置 (https://console.amap.com/)
# 用于：1. 逆地理编码（经纬度转地址）2. 天气查询
[amap]
api-key = ""  # 高德地图 Web 服务 API Key

# 微信小程序配置 (https://mp.weixin.qq.com/)
[idps.wxmp]
appid = ""  # 微信小程序 AppID
secret = ""  # 微信小程序 Secret

# 抖音小程序配置 (https://developer.open-douyin.com/)
[idps.tt]
appid = ""  # 抖音小程序 AppID
secret = ""  # 抖音小程序 Secret

# 支付宝小程序配置 (https://open.alipay.com/)
[idps.alipay]
appid = ""  # 支付宝小程序 AppID
secret = ""  # 应用私钥（PKCS8 DER Base64，用于签名请求）
verify-key = ""  # 支付宝公钥（PKCS8 DER Base64，上传应用公钥后支付宝返回，用于验证响应签名）

# Captcha 人机验证配置（Cloudflare Turnstile）
# 获取密钥: https://dash.cloudflare.com/turnstile
[captcha]
provider = "turnstile"  # 验证提供商：turnstile
site-key = ""           # 站点密钥（前端使用）
secret-key = ""         # 密钥（后端验证使用）

# Aegis 认证配置
[aegis]
endpoint = "https://aegis.heliannuuthus.com"    # Aegis 服务端点（issuer 自动拼接为 endpoint/api）
expires-in = 7200           # access_token 过期时间(秒)，2小时
refresh-expires-in = 365    # refresh_token 过期时间(天)，1年
max-refresh-token = 10      # 每用户最大 refresh_token 数
service-url = "http://localhost:18000"  # Aegis 服务地址（内部调用）

# Cookie 配置（Aegis 模块登录会话）
[aegis.cookie]
domain = ""                 # Cookie 域名（留空则从 endpoint 自动提取）
path = "/"                  # Cookie 路径
secure = true               # 是否仅 HTTPS
http-only = true            # 是否仅 HTTP（防 XSS）
max-age = 600               # 最大存活时间（秒），默认 10 分钟

# 端点配置（Aegis 模块登录页面路径）
[aegis.endpoints]
login = "/login"            # 登录页面
consent = "/consent"        # 授权同意页面
mfa = "/mfa"                # MFA 验证页面
error = "/error"            # 错误页面
callback = "/callback"      # IDP 回调路径

# 支持的 audience 及其解密密钥（用于后端服务验证 token）
# 每个 key 是 audience（服务 ID），value 是 Base64URL 编码的 32 字节密钥
[aegis.secrets]
# zwei = "base64url_encoded_32byte_key"
# hermes = "base64url_encoded_32byte_key"

# 域配置（注意：实际配置在 hermes.toml 中，这里仅作参考）
# 密钥使用 python3 scripts/initialize-hermes.py 生成
# [aegis.domains.ciam]
# name = "Customer Identity"           # 域名称
# description = "C端用户身份域"         # 域描述
# 签名密钥（32 字节 Ed25519 seed，Base64URL 编码）
# 支持密钥轮换：逗号分隔多个密钥，第一把是主密钥用于签发，其余是旧密钥用于验证
# sign-keys = "base64url_32byte_seed"

# 数据库加密密钥（注意：实际配置在 hermes.toml 中）
# [db]
# enc-key = ""   # AES-256-GCM 加密密钥（Base64 编码，32字节）

# 首页轮播图配置
[[home.banners]]
id = "banner_1"
image-url = "https://example.com/banner1.jpg"
title = "今日推荐"
link = ""
link-type = "none"  # recipe, url, none

[[home.banners]]
id = "banner_2"
image-url = "https://example.com/banner2.jpg"
title = "新菜上线"
link = "recipe_id_here"
link-type = "recipe"

# Hermes 缓存配置（用于 aegis 模块缓存 hermes 数据）
# 每个 cache 类型都有独立的配置前缀，支持独立配置和热更新
# 配置格式：aegis.cache.{type}.{config-key}

# Domain 缓存配置（含密钥）
[aegis.cache.domain]
key-prefix = "domain:"        # 缓存 key 前缀
cache-size = 100             # 最大缓存条目数
num-counters = 1000          # 计数器数量（ristretto 内部使用）
buffer-items = 64           # 缓冲区大小
ttl = "5m"                   # 缓存过期时间（支持热更新）

# Application 缓存配置（含密钥）
[aegis.cache.application]
key-prefix = "app:"          # 缓存 key 前缀
cache-size = 500             # 最大缓存条目数
num-counters = 5000          # 计数器数量
buffer-items = 64            # 缓冲区大小
ttl = "2m"                   # 缓存过期时间（支持热更新）

# Service 缓存配置（含密钥）
[aegis.cache.service]
key-prefix = "svc:"          # 缓存 key 前缀
cache-size = 500             # 最大缓存条目数
num-counters = 5000          # 计数器数量
buffer-items = 64            # 缓冲区大小
ttl = "2m"                   # 缓存过期时间（支持热更新）

# User 缓存配置
[aegis.cache.user]
key-prefix = "user:"         # 缓存 key 前缀
cache-size = 10000           # 最大缓存条目数
num-counters = 100000        # 计数器数量
buffer-items = 64            # 缓冲区大小
ttl = "10m"                  # 缓存过期时间（支持热更新）

# ApplicationServiceRelation 缓存配置（应用可申请的服务关系）
[aegis.cache.application-service-relation]
key-prefix = "app-svc-rel:"  # 缓存 key 前缀
cache-size = 2000            # 最大缓存条目数
num-counters = 20000         # 计数器数量
buffer-items = 64            # 缓冲区大小
ttl = "5m"                   # 缓存过期时间（支持热更新）

# Relationship 缓存配置（服务关系）
[aegis.cache.relationship]
key-prefix = "rel:"          # 缓存 key 前缀
cache-size = 5000            # 最大缓存条目数
num-counters = 50000         # 计数器数量
buffer-items = 64            # 缓冲区大小
ttl = "5m"                   # 缓存过期时间（支持热更新）

# Challenge 缓存配置（MFA 验证）
[aegis.cache.challenge]
key-prefix = "aegis:ch:"      # 缓存 key 前缀
expires_in = "5m"            # Challenge 过期时间（支持热更新）

# 阿里云 OSS 配置（用于图片上传）[已废弃，迁移至 R2]
# [oss]
# endpoint = ""           # OSS 地域节点，如 oss-cn-hangzhou.aliyuncs.com
# access-key-id = ""      # AccessKey ID
# access-key-secret = ""  # AccessKey Secret
# bucket = ""             # Bucket 名称
# domain = ""             # 自定义域名（可选），如 https://cdn.example.com
# region = ""             # STS 区域（可选，默认从 endpoint 提取）
# role-arn = ""           # RAM 角色 ARN

# Cloudflare R2 配置（用于图片上传，S3 兼容）
[r2]
account-id = ""         # Cloudflare Account ID
access-key-id = ""      # R2 API Token (Access Key ID)，在 Cloudflare Dashboard -> R2 -> Manage R2 API Tokens 创建
access-key-secret = ""  # R2 API Token (Secret Access Key)
bucket = ""             # R2 Bucket 名称
domain = ""             # 自定义域名（R2 Custom Domain 或 Workers 域名），如 https://cdn.example.com
