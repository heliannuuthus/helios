# MySQL 配置文件
# 基于 MySQL 8.0 官方镜像默认配置，添加自定义优化

# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/8.0/en/server-configuration-defaults.html

[mysqld]
# ==================== MySQL 默认配置（来自官方镜像）====================
skip-host-cache
skip-name-resolve
datadir=/var/lib/mysql
socket=/var/run/mysqld/mysqld.sock
secure-file-priv=/var/lib/mysql-files
user=mysql
pid-file=/var/run/mysqld/mysqld.pid

# ==================== 基础配置 ====================
# 字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# 默认存储引擎
default-storage-engine = InnoDB

# 端口
port = 3306

# 绑定地址
bind-address = 0.0.0.0

# ==================== 内存配置（针对 1.6GB 服务器，与业务服务共存优化）====================
# InnoDB 缓冲池大小：设置为 300MB，为业务服务预留更多内存
innodb_buffer_pool_size = 300M

# InnoDB 日志文件大小（每个日志文件）
innodb_log_file_size = 64M

# InnoDB 日志缓冲区大小（降低以节省内存）
innodb_log_buffer_size = 8M

# 临时表最大内存大小（降低以节省内存）
tmp_table_size = 16M
max_heap_table_size = 16M

# 排序缓冲区大小
sort_buffer_size = 2M

# 读取缓冲区大小
read_buffer_size = 1M
read_rnd_buffer_size = 2M

# 连接缓冲区大小
join_buffer_size = 2M

# 线程缓存
thread_cache_size = 8

# 表缓存（降低以节省内存，用量不大时足够）
table_open_cache = 1000
table_definition_cache = 800

# ==================== 连接配置 ====================
# 最大连接数（用量不大时降低，节省内存）
max_connections = 50

# 最大用户连接数
max_user_connections = 30

# 连接超时
wait_timeout = 28800
interactive_timeout = 28800

# ==================== 查询配置 ====================
# 最大数据包大小（降低以节省内存）
max_allowed_packet = 32M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/lib/mysql/slow-query.log
long_query_time = 2

# ==================== InnoDB 配置 ====================
# InnoDB 刷新方法（O_DIRECT 减少操作系统缓存占用）
innodb_flush_method = O_DIRECT

# InnoDB 刷新日志频率
innodb_flush_log_at_trx_commit = 2

# InnoDB 文件格式（MySQL 8.0 只支持 Barracuda，无需显式指定）
# innodb_file_format = Barracuda  # MySQL 8.0 已废弃此选项
innodb_file_per_table = 1

# InnoDB 线程并发数
innodb_thread_concurrency = 2

# InnoDB 读取 IO 线程数
innodb_read_io_threads = 2

# InnoDB 写入 IO 线程数
innodb_write_io_threads = 2

# InnoDB 脏页刷新比例
innodb_max_dirty_pages_pct = 75

# ==================== 二进制日志配置 ====================
# 启用二进制日志（用于主从复制和数据恢复）
# MySQL 8.0 默认日志路径在 /var/lib/mysql/，使用相对路径即可
log_bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# ==================== 错误日志配置 ====================
# MySQL 8.0 默认错误日志输出到 stderr，如需文件日志可取消注释
# log_error = /var/lib/mysql/error.log
log_error_verbosity = 2

# ==================== 其他配置 ====================
# 禁用符号链接
symbolic-links = 0

# SQL 模式
sql_mode = STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

# 时区
default-time-zone = '+08:00'

# 禁用性能模式（节省内存）
performance_schema = OFF

# ==================== 客户端配置 ====================
[client]
socket=/var/run/mysqld/mysqld.sock
default-character-set = utf8mb4
port = 3306

[mysql]
default-character-set = utf8mb4

[mysqldump]
default-character-set = utf8mb4
single-transaction
quick
