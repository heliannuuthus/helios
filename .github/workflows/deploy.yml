name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
    branches: [main, master]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string

env:
  IMAGE_NAME: choosy-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set image tag
        id: tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            COMMIT_SHA=$(git rev-parse --short HEAD)
            IMAGE_TAG="${TIMESTAMP}-${COMMIT_SHA}"
          else
            IMAGE_TAG="latest"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploy image tag: ${IMAGE_TAG}"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            
            REG_VPC_ENDPOINT="${{ vars.REG_VPC_ENDPOINT }}"
            REG_USERNAME="${{ secrets.REG_USERNAME }}"
            REG_PASSWORD="${{ secrets.REG_PASSWORD }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            IMAGE_TAG="${{ steps.tag.outputs.image_tag }}"
            
            IMAGE="${REG_VPC_ENDPOINT}/${REG_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
            CONTAINER_NAME="choosy-backend"
            
            echo "=== Deploying ${CONTAINER_NAME} ==="
            echo "Image: ${IMAGE}"
            
            echo "${REG_PASSWORD}" | sudo nerdctl login ${REG_VPC_ENDPOINT} -u ${REG_USERNAME} --password-stdin
            
            echo "Pulling image..."
            sudo nerdctl pull ${IMAGE}
            
            echo "Stopping old container..."
            sudo nerdctl stop ${CONTAINER_NAME} 2>/dev/null || true
            sudo nerdctl rm ${CONTAINER_NAME} 2>/dev/null || true
            
            echo "Starting new container..."
            sudo nerdctl run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p 18000:18000 \
              -v /opt/choosy/config.toml:/app/config.toml \
              -v /opt/choosy/db:/app/db \
              ${IMAGE}
            
            echo "=== Container ${CONTAINER_NAME} started ==="
            sudo nerdctl ps | grep ${CONTAINER_NAME}

      - name: Health check
        run: |
          sleep 10
          echo "Health check: http://${{ secrets.DEPLOY_HOST }}:18000/health"
          curl -f http://${{ secrets.DEPLOY_HOST }}:18000/health || exit 1
          echo "Health check passed!"
