name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
    branches: [main, master]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string

env:
  IMAGE_NAME: choosy-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    environment: ${{ github.event_name == 'push' && 'production' || inputs.environment || 'production' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment and image tag
        id: env
        run: |
          # 确定环境
          if [ "${{ github.event_name }}" = "push" ]; then
            ENV="production"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          else
            ENV="production"
          fi
          echo "env=${ENV}" >> $GITHUB_OUTPUT
          
          # 确定镜像 tag
          if [ -n "${{ inputs.image_tag }}" ]; then
            # 手动指定的 tag
            IMAGE_TAG="${{ inputs.image_tag }}"
          elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag 推送时，使用 docker.yml 生成的格式
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            COMMIT_SHA=$(git rev-parse --short HEAD)
            IMAGE_TAG="${TIMESTAMP}-${COMMIT_SHA}"
          else
            # 默认使用 latest
            IMAGE_TAG="latest"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploy env: ${ENV}, image tag: ${IMAGE_TAG}"

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            
            # 登录镜像仓库
            docker login ${{ vars.REG_ENDPOINT }} -u ${{ secrets.REG_USERNAME }} -p ${{ secrets.REG_PASSWORD }}
            
            # 拉取镜像
            IMAGE="${{ vars.REG_ENDPOINT }}/${{ secrets.REG_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.env.outputs.image_tag }}"
            echo "Pulling image: ${IMAGE}"
            docker pull ${IMAGE}
            
            # 停止并删除旧容器
            CONTAINER_NAME="choosy-backend-${{ steps.env.outputs.env }}"
            docker stop ${CONTAINER_NAME} 2>/dev/null || true
            docker rm ${CONTAINER_NAME} 2>/dev/null || true
            
            # 启动新容器
            PORT=${{ steps.env.outputs.env == 'production' && '18000' || '18001' }}
            docker run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${PORT}:18000 \
              -v /opt/choosy/${{ steps.env.outputs.env }}/config.toml:/app/config.toml \
              -v /opt/choosy/${{ steps.env.outputs.env }}/db:/app/db \
              ${IMAGE}
            
            echo "Container ${CONTAINER_NAME} started on port ${PORT}"

      - name: Health check
        run: |
          sleep 10
          PORT=${{ steps.env.outputs.env == 'production' && '18000' || '18001' }}
          echo "Health check: http://${{ secrets.DEPLOY_HOST }}:${PORT}/health"
          curl -f http://${{ secrets.DEPLOY_HOST }}:${PORT}/health || exit 1
          echo "Health check passed!"
