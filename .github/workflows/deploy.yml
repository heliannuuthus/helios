name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build & Push"]
    types: [completed]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (leave empty for latest)'
        required: false
        type: string

env:
  IMAGE_NAME: choosy-backend

jobs:
  # 准备部署信息
  prepare:
    runs-on: ubuntu-latest
    # 只有 tag 触发的 build 完成后，或者手动触发时才运行
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.workflow_run.conclusion == 'success' && startsWith(github.event.workflow_run.head_branch, 'v'))
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
    steps:
      - name: Set image tag
        id: tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          else
            # 从上游 workflow 获取 tag 名称
            IMAGE_TAG="${{ github.event.workflow_run.head_branch }}"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploy image tag: ${IMAGE_TAG}"

  # 部署（需要审批）
  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            
            REG_VPC_ENDPOINT="${{ vars.REG_VPC_ENDPOINT }}"
            REG_USERNAME="${{ secrets.REG_USERNAME }}"
            REG_PASSWORD="${{ secrets.REG_PASSWORD }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            IMAGE_TAG="${{ needs.prepare.outputs.image_tag }}"
            
            IMAGE="${REG_VPC_ENDPOINT}/${REG_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
            CONTAINER_NAME="choosy-backend"
            
            echo "=== Deploying ${CONTAINER_NAME} ==="
            echo "Image: ${IMAGE}"
            
            echo "${REG_PASSWORD}" | sudo nerdctl login ${REG_VPC_ENDPOINT} -u ${REG_USERNAME} --password-stdin
            
            echo "Pulling image..."
            sudo nerdctl pull ${IMAGE}
            
            echo "Stopping old container..."
            sudo nerdctl stop ${CONTAINER_NAME} 2>/dev/null || true
            sudo nerdctl rm ${CONTAINER_NAME} 2>/dev/null || true
            
            echo "Starting new container..."
            sudo nerdctl run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p 18000:18000 \
              -v /opt/choosy/config.toml:/app/config.toml \
              -v /opt/choosy/db:/app/db \
              ${IMAGE}
            
            echo "=== Container ${CONTAINER_NAME} started ==="
            sudo nerdctl ps | grep ${CONTAINER_NAME}

      - name: Health check
        run: |
          sleep 10
          echo "Health check: http://${{ secrets.DEPLOY_HOST }}:18000/health"
          curl -f http://${{ secrets.DEPLOY_HOST }}:18000/health || exit 1
          echo "Health check passed!"
