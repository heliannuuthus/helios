name: Pipeline

on:
  push:
    branches: [master, main]
    tags: ["v*"]
  pull_request:
    branches: [master, main]

env:
  IMAGE_NAME: choosy-backend

jobs:
  # ========== CI Jobs ==========
  lint:
    # Tag 推送跳过 lint
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          $(go env GOPATH)/bin/golangci-lint --version

      - name: golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run

  test:
    # Tag 推送跳过 test
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage.out
        continue-on-error: true

  check-generate:
    # Tag 推送跳过 check-generate
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Install tools
        run: |
          go install github.com/google/wire/cmd/wire@latest
          go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate
        run: |
          wire ./...
          swag init --parseDependency --parseInternal

      - name: Check for changes
        run: |
          if [ -n "$(git status --porcelain docs/ wire_gen.go)" ]; then
            echo "::error::生成的代码有变更，请先运行 make generate 并提交"
            git diff docs/ wire_gen.go
            exit 1
          fi

  # ========== Build & Push ==========
  build-and-push:
    runs-on: ubuntu-latest
    needs: [lint, test, check-generate]
    # PR 不构建镜像
    # Tag 推送时 CI jobs 被跳过，用 always() + 条件判断
    if: |
      always() &&
      github.event_name == 'push' &&
      (
        startsWith(github.ref, 'refs/tags/') ||
        (needs.lint.result == 'success' && needs.test.result == 'success' && needs.check-generate.result == 'success')
      )
    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.REG_ENDPOINT }}
          username: ${{ secrets.REG_USERNAME }}
          password: ${{ secrets.REG_PASSWORD }}

      - name: Generate image tags
        id: meta
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          RUN_NUMBER=${{ github.run_number }}
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            TAG="${VERSION}"
          else
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            TAG="${LATEST_TAG}-alpha-${RUN_NUMBER}-${COMMIT_SHA}"
            VERSION="${TAG}"
          fi
          
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}, version: ${VERSION}"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ vars.REG_ENDPOINT }}/${{ secrets.REG_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ vars.REG_ENDPOINT }}/${{ secrets.REG_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            ENV=${{ github.ref == 'refs/heads/main' && 'prod' || '' }}
          provenance: false

  # ========== Deploy ==========
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push'
    environment: production
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            
            REG_VPC_ENDPOINT="${{ vars.REG_VPC_ENDPOINT }}"
            REG_USERNAME="${{ secrets.REG_USERNAME }}"
            REG_PASSWORD="${{ secrets.REG_PASSWORD }}"
            IMAGE_NAME="${{ env.IMAGE_NAME }}"
            IMAGE_TAG="${{ needs.build-and-push.outputs.image_tag }}"
            
            IMAGE="${REG_VPC_ENDPOINT}/${REG_USERNAME}/${IMAGE_NAME}:${IMAGE_TAG}"
            CONTAINER_NAME="choosy-backend"
            
            echo "=== Deploying ${CONTAINER_NAME} ==="
            echo "Image: ${IMAGE}"
            
            echo "${REG_PASSWORD}" | sudo nerdctl login ${REG_VPC_ENDPOINT} -u ${REG_USERNAME} --password-stdin
            
            echo "Pulling image..."
            sudo nerdctl pull ${IMAGE}
            
            echo "Stopping old container..."
            sudo nerdctl stop ${CONTAINER_NAME} 2>/dev/null || true
            sudo nerdctl rm ${CONTAINER_NAME} 2>/dev/null || true
            
            echo "Starting new container..."
            sudo nerdctl run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p 18000:18000 \
              -e APP_ENV=prod \
              -v /opt/choosy/config.toml:/app/config.toml \
              -v /opt/choosy/db:/app/db \
              ${IMAGE}
            
            echo "=== Container ${CONTAINER_NAME} started ==="
            sudo nerdctl ps | grep ${CONTAINER_NAME}

      - name: Health check
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            sleep 5
            echo "Health check via localhost..."
            curl -f http://localhost:18000/health || exit 1
            echo "Health check passed!"

